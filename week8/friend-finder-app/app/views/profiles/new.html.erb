<div class="max-w-2xl mx-auto">
  <div class="bg-white shadow-lg rounded-lg px-8 py-10">
    <h1 class="font-bold text-3xl text-center text-indigo-600 mb-4">Create Your Profile</h1>
    <p class="text-gray-600 text-center mb-8">Tell us about yourself so we can find your perfect friend matches</p>

    <!-- Voice Input Section -->
    <div class="mb-8 p-6 bg-indigo-50 rounded-lg">
      <h2 class="font-bold text-xl text-indigo-900 mb-4">Voice Intake (Optional)</h2>
      <p class="text-sm text-gray-700 mb-4">Click the button and tell us about your interests, ideal weekend, and what you're looking for in friendships. We'll automatically fill in your profile!</p>

      <div class="flex flex-col items-center space-y-4">
        <button id="voice-button" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-md">
          ðŸŽ¤ Start Voice Input
        </button>
        <p id="voice-status" class="text-sm text-gray-600"></p>
        <textarea id="voice-transcript" class="w-full p-3 border border-gray-300 rounded-md hidden" rows="4" placeholder="Your transcript will appear here..."></textarea>
      </div>
    </div>

    <%= form_with model: @profile, url: profiles_path, class: "space-y-6" do |f| %>
      <% if @profile&.errors&.any? %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          <ul class="list-disc list-inside">
            <% @profile.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div>
        <%= f.label :hometown, "Hometown", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :hometown, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border" %>
      </div>

      <div>
        <%= f.label :interests, "Interests (comma separated)", class: "block text-sm font-medium text-gray-700" %>
        <%= text_field_tag "profile[interests]", "", id: "interests-field", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border", placeholder: "e.g., hiking, coffee, board games" %>
      </div>

      <div>
        <%= f.label :social_energy, "Social Energy", class: "block text-sm font-medium text-gray-700" %>
        <%= f.select :social_energy, [["Introvert", "introvert"], ["Ambivert", "ambivert"], ["Extrovert", "extrovert"]], {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border" %>
      </div>

      <div>
        <%= f.label :preferred_formats, "Preferred Hangout Formats (comma separated)", class: "block text-sm font-medium text-gray-700" %>
        <%= text_field_tag "profile[preferred_formats]", "", id: "formats-field", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border", placeholder: "e.g., 1-on-1 coffee, group hikes" %>
      </div>

      <div>
        <%= f.label :vibes, "Your Vibes (comma separated)", class: "block text-sm font-medium text-gray-700" %>
        <%= text_field_tag "profile[vibes]", "", id: "vibes-field", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border", placeholder: "e.g., chill outdoorsy, creative" %>
      </div>

      <div>
        <%= f.label :routine, "Typical Routine / Best Times to Hang Out", class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_area :routine, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 border", placeholder: "When are you usually free? Weekends? Evenings?" %>
      </div>

      <%= f.hidden_field :transcript, id: "transcript-field" %>

      <div>
        <%= f.submit "Create Profile", class: "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-md cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Simple voice recognition using Web Speech API
  document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('voice-button');
    const status = document.getElementById('voice-status');
    const transcriptArea = document.getElementById('voice-transcript');
    const transcriptField = document.getElementById('transcript-field');

    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      status.textContent = 'Voice recognition not supported in this browser';
      button.disabled = true;
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;

    let isRecording = false;
    let fullTranscript = '';

    button.addEventListener('click', function() {
      if (!isRecording) {
        recognition.start();
        isRecording = true;
        button.textContent = 'ðŸ›‘ Stop Recording';
        button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        button.classList.add('bg-red-600', 'hover:bg-red-700');
        status.textContent = 'Listening... Tell us about yourself!';
        transcriptArea.classList.remove('hidden');
      } else {
        recognition.stop();
        isRecording = false;
        button.textContent = 'ðŸŽ¤ Start Voice Input';
        button.classList.remove('bg-red-600', 'hover:bg-red-700');
        button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        status.textContent = 'Processing...';

        // Auto-fill fields based on transcript (simplified version)
        autoFillFromTranscript(fullTranscript);
      }
    });

    recognition.onresult = function(event) {
      let interimTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          fullTranscript += transcript + ' ';
        } else {
          interimTranscript += transcript;
        }
      }
      transcriptArea.value = fullTranscript + interimTranscript;
      transcriptField.value = fullTranscript;
    };

    function autoFillFromTranscript(transcript) {
      // Simple keyword matching (in production, this would call the API)
      const lowerTranscript = transcript.toLowerCase();

      // Extract interests
      const interests = [];
      if (lowerTranscript.includes('hik')) interests.push('hiking');
      if (lowerTranscript.includes('coffee')) interests.push('coffee');
      if (lowerTranscript.includes('game')) interests.push('games');
      if (lowerTranscript.includes('music') || lowerTranscript.includes('concert')) interests.push('music');
      if (lowerTranscript.includes('art')) interests.push('art');

      if (interests.length > 0) {
        document.getElementById('interests-field').value = interests.join(', ');
      }

      status.textContent = 'Done! Review and edit the fields below, then submit.';
    }
  });
</script>
